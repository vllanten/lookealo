[{"id":"1b584050.d1073","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"e0f3fdbf.31d64","type":"remote-server","z":"","name":"elk","host":"http://elk:9200"},{"id":"e6cfb3b3.94879","type":"function","z":"1b584050.d1073","name":"crawler_yapo_cl","func":"var Crawler = context.global.crawler;\nvar type_elk = \"yapo_cl\"\n\nvar c = new Crawler({\n    maxConnections: 10,\n    rateLimit: 1000,\n    callback: function (error, res, done) {\n        if (error) {\n            // :(\n        } else {\n            var $ = res.$;\n            //analizo la tabla\n            var resultados = []\n            $(\".listing_thumbs\").each(function (a, b) {\n                //tr a tr\n                $(b).find(\"tr\").each(function (k1, tr) {\n                    aviso = {}\n                    //obtengo data\n                    aviso.id = type_elk + \"_\" +$(tr).attr(\"id\")\n                    aviso.precio = $(tr).find(\".price\").text().replace(/\\s/g, '') //TODO transformar a n√∫mero\n                    aviso.titulo = $(tr).find(\".title\").text() //TODO reconocer marcas y modelos\n                    aviso.url = $(tr).find(\".redirect-to-url\").attr(\"href\")\n                    aviso.estado = \"obtenido\"\n                    aviso.fecha = new Date()\n                    resultados.push(aviso)\n                })\n            })\n        }\n        msg.resultados = resultados;\n        node.send({avisos:resultados, type_elk: type_elk});\n        \n    }\n});\n\nc.queue({\n    headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.89 Safari/537.36\"\n    },\n    uri: 'https://www.yapo.cl/chile/vehiculos?ca=15_s&l=0&st=a'\n});\n\n","outputs":1,"noerr":0,"x":320,"y":60,"wires":[["79e10e1c.19c55"]]},{"id":"366e5958.176bf6","type":"inject","z":"1b584050.d1073","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":60,"wires":[["e6cfb3b3.94879"]]},{"id":"1069bd2.98e1f43","type":"function","z":"1b584050.d1073","name":"for","func":"if(msg.avisos[msg.count]){\n    msg.payload = msg.avisos[msg.count]\n    return [null, msg]\n}else{\n    return [msg, null]\n}\n","outputs":2,"noerr":0,"x":390,"y":160,"wires":[[],["1e1eed8c.e61e32"]]},{"id":"79e10e1c.19c55","type":"function","z":"1b584050.d1073","name":"init count","func":"msg.count = 0\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":160,"wires":[["1069bd2.98e1f43"]]},{"id":"396134ab.8f2a1c","type":"function","z":"1b584050.d1073","name":"count++","func":"msg.count = msg.count +1 \nreturn msg;","outputs":1,"noerr":0,"x":400,"y":280,"wires":[["1069bd2.98e1f43"]]},{"id":"1e1eed8c.e61e32","type":"function","z":"1b584050.d1073","name":"","func":"\nmsg.documentIndex = \"avisos\"\nmsg.documentType = msg.type_elk\nmsg.documentId = msg.type_elk+\"_\"+msg.payload.id\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":180,"wires":[["396134ab.8f2a1c","3ad2b19d.d97e7e"]]},{"id":"1b5fca14.2c7136","type":"es-create","z":"1b584050.d1073","name":"","documentIndex":"","documentType":"","server":"e0f3fdbf.31d64","x":1210,"y":160,"wires":[[]]},{"id":"3ad2b19d.d97e7e","type":"es-exists","z":"1b584050.d1073","name":"","documentId":"","documentIndex":"","documentType":"","server":"e0f3fdbf.31d64","x":750,"y":160,"wires":[["5ba5838c.fcee0c","e12381bc.7dd9"]]},{"id":"5ba5838c.fcee0c","type":"function","z":"1b584050.d1073","name":"","func":"\nif(!msg.exists){\n  return [msg, null];    \n}else{\n  return [null,msg];\n}","outputs":2,"noerr":0,"x":970,"y":180,"wires":[["1b5fca14.2c7136"],[]]},{"id":"e12381bc.7dd9","type":"debug","z":"1b584050.d1073","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":970,"y":100,"wires":[]}]